<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Herramientas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-disponible {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-en-uso {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-danada {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-reparacion {
            background-color: #fef3c7;
            color: #92400e;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md">

        <!-- Initial View -->
        <div id="initial-view" class="card space-y-4">
            <h1 class="text-2xl font-bold text-gray-800">Control de Herramientas</h1>
            <p class="text-gray-600">Por favor, introduce tu nombre para continuar.</p>
            <input type="text" id="nombre-usuario" placeholder="Tu Nombre" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
            <button id="iniciar-app-btn" class="w-full btn btn-primary">Iniciar</button>
        </div>

        <!-- Scanner View -->
        <div id="scanner-view" class="hidden flex flex-col items-center justify-center text-center">
            <div class="relative w-full h-80 bg-gray-300 rounded-lg overflow-hidden">
                <video id="video" class="absolute inset-0 w-full h-full object-cover"></video>
                <div id="overlay" class="absolute inset-0 w-full h-full border-4 border-red-500 rounded-lg transition-colors duration-200"></div>
            </div>
            <p class="mt-4 text-gray-600" id="scanner-message">Escanea el código QR del cajón.</p>
            <button id="stop-scanner-btn" class="mt-4 btn btn-secondary">Detener Escáner</button>
        </div>

        <!-- Confirm and Return View -->
        <div id="confirm-view" class="hidden card space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">Detalles del Cajón</h2>
            <p class="text-gray-600" id="tool-info"></p>
            <p class="text-sm text-gray-500" id="current-user-display"></p>
            <div id="action-buttons" class="flex flex-col space-y-3 mt-4">
                <button id="take-btn" class="w-full btn btn-primary hidden">Confirmar Toma</button>
                <button id="return-btn" class="w-full btn btn-primary hidden">Registrar Devolución</button>
                <div id="return-options" class="w-full flex flex-col space-y-3 hidden">
                    <p class="text-sm font-semibold text-gray-700">Estado al devolver:</p>
                    <button data-estado="Disponible" class="w-full btn btn-secondary estado-btn">Disponible</button>
                    <button data-estado="Dañada" class="w-full btn btn-secondary estado-btn">Dañada</button>
                </div>
            </div>
        </div>

        <!-- Action Messages -->
        <div id="messages-container" class="mt-4 w-full"></div>

        <!-- Export Button -->
        <div class="mt-6 text-center">
            <button id="export-btn" class="btn btn-secondary">Exportar Registro (CSV)</button>
        </div>

    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold mb-2 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="btn btn-primary">Cerrar</button>
        </div>
    </div>

    <script>
        // Log levels for Firestore
        // setLogLevel('debug'); // Uncomment for debugging Firestore

        const showModal = (title, message) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        };

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
        });

        // =========================================================================
        // === Database (In-Memory for this demo) ==================================
        // =========================================================================
        let registroHistorico = [];
        let herramientasDB = {
            "escenario1": {
                herramienta: "llave fija, punta llave fija, taladro",
                persona: null,
                fecha_salida: null,
                estado: "Disponible",
                ultima_persona: null,
                ultima_salida: null
            },
            "escenario2": {
                herramienta: "llave fija, taladro, punta llave fija, mazo",
                persona: null,
                fecha_salida: null,
                estado: "Disponible",
                ultima_persona: null,
                ultima_salida: null
            },
            "escenario3": {
                herramienta: "punta estrella, taladro, mazo, caja tronillos",
                persona: "Carlos",
                fecha_salida: "2025-09-10 10:30",
                estado: "En uso",
                ultima_persona: "Carlos",
                ultima_salida: "2025-09-10 10:30"
            },
            "escenario4": {
                herramienta: "lima",
                persona: null,
                fecha_salida: null,
                estado: "Dañada",
                ultima_persona: null,
                ultima_salida: null
            },
            "escalera": {
                herramienta: "broca 10mm, macho de rocsa 8 y 10mm, llave allen 8mm, punta estrella,taladro, caja tornillos, casquillo roscado",
                persona: "Lucía",
                fecha_salida: "2025-09-10 15:00",
                estado: "En uso",
                ultima_persona: "Lucía",
                ultima_salida: "2025-09-10 15:00"
            }
        };

        let usuarioActual = '';
        let herramientaEnUso = null; // To track the currently taken tool

        // =========================================================================
        // === UI State and Logic ==================================================
        // =========================================================================
        const initialView = document.getElementById('initial-view');
        const scannerView = document.getElementById('scanner-view');
        const confirmView = document.getElementById('confirm-view');
        const nombreInput = document.getElementById('nombre-usuario');
        const takeBtn = document.getElementById('take-btn');
        const returnBtn = document.getElementById('return-btn');
        const returnOptions = document.getElementById('return-options');
        const toolInfo = document.getElementById('tool-info');
        const currentUserDisplay = document.getElementById('current-user-display');
        const overlay = document.getElementById('overlay');
        const video = document.getElementById('video');
        const scannerMessage = document.getElementById('scanner-message');

        const displayView = (view) => {
            initialView.classList.add('hidden');
            scannerView.classList.add('hidden');
            confirmView.classList.add('hidden');
            view.classList.remove('hidden');
            if (view === scannerView) {
                scannerView.classList.remove('flex');
                scannerView.classList.add('flex');
            } else {
                scannerView.classList.remove('flex');
                scannerView.classList.add('hidden');
            }
        };

        document.getElementById('iniciar-app-btn').addEventListener('click', () => {
            const nombre = nombreInput.value.trim();
            if (nombre === '') {
                showModal('Error', 'Por favor, introduce tu nombre para continuar.');
            } else {
                usuarioActual = nombre;
                currentUserDisplay.innerText = `Usuario actual: ${usuarioActual}`;
                displayView(scannerView);
                startScanner();
            }
        });

        document.getElementById('stop-scanner-btn').addEventListener('click', () => {
            stopScanner();
            displayView(initialView);
        });

        // =========================================================================
        // === QR Scanner Logic ====================================================
        // =========================================================================
        let videoStream;
        let qrCodeWorker;

        const startScanner = async () => {
            try {
                // Try to get the back camera
                const constraints = { video: { facingMode: 'environment' } };
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.play();
                qrCodeWorker = setInterval(tick, 100);
            } catch (err) {
                console.error("No se pudo acceder a la cámara:", err);
                scannerMessage.innerText = "Error: No se pudo acceder a la cámara. Por favor, asegúrate de dar permiso.";
                showModal('Error', 'No se pudo acceder a la cámara. Asegúrate de dar los permisos necesarios.');
            }
        };

        const stopScanner = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            clearInterval(qrCodeWorker);
        };

        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    overlay.style.borderColor = 'green';
                    handleQrCode(code.data);
                } else {
                    overlay.style.borderColor = 'red';
                }
            }
        };

        const handleQrCode = (data) => {
            stopScanner();
            let qrData;
            try {
                qrData = JSON.parse(data);
            } catch (e) {
                showModal('Error', 'Código QR no válido. Debe contener datos en formato JSON.');
                displayView(scannerView);
                startScanner();
                return;
            }

            const toolID = qrData.id_cajon;
            const tool = herramientasDB[toolID];

            if (!tool) {
                showModal('Error', `La herramienta con el ID "${toolID}" no se ha encontrado en la base de datos.`);
                displayView(scannerView);
                startScanner();
                return;
            }

            // --- Logic to handle tool state ---
            if (tool.estado === "En uso" && tool.persona === usuarioActual) {
                herramientaEnUso = toolID;
                displayConfirmation(toolID, tool, 'devolver');
            } else if (tool.estado === "En uso" && tool.persona !== usuarioActual) {
                showModal('Error', `Esta herramienta ya está en uso por ${tool.persona}. No puedes tomarla.`);
                displayView(scannerView);
                startScanner();
            } else if (tool.estado === "Dañada") {
                showModal('Error', 'Esta herramienta está dañada y no se puede tomar.');
                displayView(scannerView);
                startScanner();
            } else if (herramientaEnUso) {
                showModal('Error', 'Ya tienes una herramienta registrada. Debes devolverla antes de tomar otra.');
                displayView(scannerView);
                startScanner();
            } else {
                herramientaEnUso = toolID;
                displayConfirmation(toolID, tool, 'tomar');
            }
        };

        const displayConfirmation = (id, tool, action) => {
            let badgeClass = 'status-disponible';
            if (tool.estado === 'En uso') badgeClass = 'status-en-uso';
            if (tool.estado === 'Dañada') badgeClass = 'status-danada';

            toolInfo.innerHTML = `
                <div class="mb-2 font-semibold text-gray-800 text-lg">${id}</div>
                <div class="text-gray-700">Herramientas: ${tool.herramienta}</div>
                <div class="mt-2 text-sm">
                    <span class="${badgeClass} status-badge">${tool.estado}</span>
                </div>
            `;
            
            takeBtn.classList.add('hidden');
            returnBtn.classList.add('hidden');
            returnOptions.classList.add('hidden');
            
            if (action === 'tomar') {
                takeBtn.classList.remove('hidden');
            } else if (action === 'devolver') {
                returnBtn.classList.remove('hidden');
            }
            
            displayView(confirmView);
        };

        takeBtn.addEventListener('click', () => {
            const toolID = herramientaEnUso;
            const tool = herramientasDB[toolID];

            const now = new Date();
            const fechaSalida = now.toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });

            tool.persona = usuarioActual;
            tool.fecha_salida = fechaSalida;
            tool.estado = 'En uso';
            tool.ultima_persona = usuarioActual;
            tool.ultima_salida = fechaSalida;

            registroHistorico.push({
                cajon_id: toolID,
                herramientas: tool.herramienta,
                persona: usuarioActual,
                tipo_movimiento: 'Salida',
                fecha: now.toISOString(),
                estado_devolucion: null
            });

            showModal('¡Listo!', `Has tomado la herramienta de "${toolID}".`);
            displayView(scannerView);
            startScanner();
        });

        returnBtn.addEventListener('click', () => {
            returnBtn.classList.add('hidden');
            returnOptions.classList.remove('hidden');
        });

        document.querySelectorAll('.estado-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const toolID = herramientaEnUso;
                const tool = herramientasDB[toolID];
                const estadoDevuelto = btn.getAttribute('data-estado');

                const now = new Date();
                const fechaDevolucion = now.toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });

                tool.persona = null;
                tool.fecha_salida = null;
                tool.estado = estadoDevuelto;
                tool.fecha_devolucion = fechaDevolucion;

                registroHistorico.push({
                    cajon_id: toolID,
                    herramientas: tool.herramienta,
                    persona: usuarioActual,
                    tipo_movimiento: 'Devolución',
                    fecha: now.toISOString(),
                    estado_devolucion: estadoDevuelto
                });
                
                herramientaEnUso = null; // Free up the tool slot
                showModal('Devolución Registrada', `Has devuelto la herramienta de "${toolID}" con el estado: ${estadoDevuelto}.`);
                displayView(scannerView);
                startScanner();
            });
        });

        // =========================================================================
        // === Export Logic ========================================================
        // =========================================================================
        document.getElementById('export-btn').addEventListener('click', () => {
            if (registroHistorico.length === 0) {
                showModal('Error', 'No hay datos en el registro para exportar.');
                return;
            }

            let csv = 'Cajón ID,Herramientas,Persona,Tipo de Movimiento,Fecha,Estado de Devolución\n';
            registroHistorico.forEach(registro => {
                const fila = [
                    `"${registro.cajon_id}"`,
                    `"${registro.herramientas.replace(/"/g, '""')}"`, // Handle commas in tool names
                    `"${registro.persona}"`,
                    `"${registro.tipo_movimiento}"`,
                    `"${registro.fecha}"`,
                    `"${registro.estado_devolucion || 'N/A'}"`
                ].join(',');
                csv += fila + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "registro_herramientas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
